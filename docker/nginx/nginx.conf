# Copyright (C) 2017-2026 Smart Code OOD 203358507
# Nginx configuration for stremio-service

user nginx;
worker_processes auto;
pcre_jit on;

error_log /dev/stderr warn;
pid /run/nginx/nginx.pid;

include /etc/nginx/modules/*.conf;

events {
    worker_connections 1024;
    multi_accept on;
    use epoll;
}

http {
    # Basic settings
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # Security: Hide nginx version
    server_tokens off;
    
    # Request size limit
    client_max_body_size 100m;
    
    # Performance optimizations
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    
    # Keep-alive settings
    keepalive_timeout 65;
    keepalive_requests 100;
    
    # Hash settings
    proxy_headers_hash_max_size 1024;
    proxy_headers_hash_bucket_size 128;
    
    # SSL settings (for HTTPS mode)
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1h;
    ssl_session_tickets off;
    
    # Logging format
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    # Log format for security monitoring (includes more details)
    log_format security '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for" '
                        'rt=$request_time uct="$upstream_connect_time" '
                        'uht="$upstream_header_time" urt="$upstream_response_time"';
    
    access_log /dev/stdout main;
    
    # Rate limiting zones
    # General rate limit: 10 requests/second per IP
    limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
    
    # Strict rate limit for auth endpoints: 1 request/second
    limit_req_zone $binary_remote_addr zone=auth:10m rate=1r/s;
    
    # Scanner blocking rate limit: very low threshold
    limit_req_zone $binary_remote_addr zone=scanner:10m rate=1r/m;
    
    # Connection limiting
    limit_conn_zone $binary_remote_addr zone=conn_limit:10m;
    
    # Include blocked IPs (updated by ip-banner.sh)
    include /etc/nginx/blocked_ips.conf;
    
    # Include scanner blocking rules
    include /etc/nginx/scanner_block.conf;
    
    # Include virtual host configurations
    include /etc/nginx/http.d/*.conf;
}
